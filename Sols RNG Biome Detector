local SoundService = game:GetService("SoundService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local StarterGui = game:GetService("StarterGui")

local BIOME_DETECTIONS = {
    {
        soundId = "rbxassetid://9044565954",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Windy Biome!",
        exitMessage = "Windy Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://9046862941",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Normal Biome!",
        exitMessage = "Normal Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1837667693",
        soundGroup = "BackgroundMusic",
        message = "Detected Null Biome!",
        exitMessage = "Null Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://9043887091",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Rainy Biome!",
        exitMessage = "Rainy Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1837093849",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Hell Biome!",
        exitMessage = "Hell Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1837897153",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Corruption Biome!",
        exitMessage = "Corruption Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1836349593",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Starfall Biome!",
        exitMessage = "Starfall Biome Has Ended!"
    }
}

local activeBiomes = {}
local notificationQueue = {}
local isShowingNotification = false

local function showNotification(message, callback)
    isShowingNotification = true
    StarterGui:SetCore("SendNotification", {
        Title = "Biome Detector",
        Text = message,
        Duration = 5,
        Callback = function()
            isShowingNotification = false
            if callback then callback() end
            if #notificationQueue > 0 then
                local nextNotif = table.remove(notificationQueue, 1)
                showNotification(nextNotif.message, nextNotif.callback)
            end
        end
    })
end

local function queueNotification(message, callback)
    if isShowingNotification then
        table.insert(notificationQueue, {message = message, callback = callback})
    else
        showNotification(message, callback)
    end
end

local function checkBiomes()
    local currentlyPlaying = {}
    local newBiomes = {}

    for _, sound in ipairs(SoundService:GetDescendants()) do
        if sound:IsA("Sound") and sound.IsPlaying then
            local soundGroupName = sound.SoundGroup and sound.SoundGroup.Name or "None"
            for _, biome in ipairs(BIOME_DETECTIONS) do
                if sound.SoundId == biome.soundId and soundGroupName == biome.soundGroup then
                    currentlyPlaying[biome.soundId] = true
                    if not activeBiomes[biome.soundId] then
                        newBiomes[biome.soundId] = biome
                    end
                    break
                end
            end
        end
    end

    for soundId, biome in pairs(newBiomes) do
        activeBiomes[soundId] = true
        queueNotification(biome.message, function() end)
    end

    for soundId, _ in pairs(activeBiomes) do
        if not currentlyPlaying[soundId] then
            for _, biome in ipairs(BIOME_DETECTIONS) do
                if biome.soundId == soundId then
                    queueNotification(biome.exitMessage, function()
                        activeBiomes[soundId] = nil
                    end)
                    break
                end
            end
        end
    end
end

RunService.Heartbeat:Connect(function()
    checkBiomes()
end)
