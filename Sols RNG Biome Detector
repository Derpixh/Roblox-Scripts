local SoundService = game:GetService("SoundService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local StarterGui = game:GetService("StarterGui")

local BIOME_DETECTIONS = {
    {
        soundId = "rbxassetid://9044565954",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Windy Biome!",
        exitMessage = "Windy Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://9046862941",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Normal Biome!",
        exitMessage = "Normal Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1837667693",
        soundGroup = "BackgroundMusic",
        message = "Detected Null Biome!",
        exitMessage = "Null Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://9043887091",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Rainy Biome!",
        exitMessage = "Rainy Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1837093849",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Hell Biome!",
        exitMessage = "Hell Biome Has Ended!"
    },
    {
        soundId = "rbxassetid://1837897153",
        soundGroup = "PlayerBackgroundMusic",
        message = "Detected Corruption Biome!",
        exitMessage = "Corruption Biome Has Ended!"
    }
}

local activeBiomes = {}
local notificationQueue = {}

local function processNotificationQueue()
    if #notificationQueue > 0 then
        local notif = table.remove(notificationQueue, 1)
        StarterGui:SetCore("SendNotification", {
            Title = "Biome Detector",
            Text = notif.message,
            Duration = 5,
        })
        if notif.callback then
            notif.callback()
        end
    end
end

local function queueNotification(message, callback)
    table.insert(notificationQueue, {
        message = message,
        callback = callback
    })
    if #notificationQueue == 1 then
        processNotificationQueue()
    end
end

local function onNotificationClosed()
    processNotificationQueue()
end

local function checkBiomes()
    local currentlyPlaying = {}
    
    for _, sound in ipairs(SoundService:GetDescendants()) do
        if sound:IsA("Sound") and sound.IsPlaying then
            local soundGroupName = sound.SoundGroup and sound.SoundGroup.Name or "None"
            for _, biome in ipairs(BIOME_DETECTIONS) do
                if sound.SoundId == biome.soundId and soundGroupName == biome.soundGroup then
                    currentlyPlaying[biome.soundId] = true
                    if not activeBiomes[biome.soundId] then
                        queueNotification(biome.message, function()
                            activeBiomes[biome.soundId] = true
                        end)
                    end
                    break
                end
            end
        end
    end
    
    for soundId, _ in pairs(activeBiomes) do
        if not currentlyPlaying[soundId] then
            for _, biome in ipairs(BIOME_DETECTIONS) do
                if biome.soundId == soundId then
                    queueNotification(biome.exitMessage, function()
                        activeBiomes[soundId] = nil
                    end)
                    break
                end
            end
        end
    end
end

StarterGui:GetPropertyChangedSignal("CurrentScreen"):Connect(function()
    if #notificationQueue > 0 then
        processNotificationQueue()
    end
end)

RunService.Heartbeat:Connect(function()
    checkBiomes()
end)
